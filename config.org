#+TITLE: Havner's Emacs configuration

* Packages
** Sources
#+BEGIN_SRC emacs-lisp
  (add-to-list 'package-archives '("melpa" . "http://melpa.milkbox.net/packages/"))
#+END_SRC

** Hand addons (helpa)
#+BEGIN_SRC emacs-lisp
  (add-to-list 'load-path "~/.emacs.d/helpa/emacs-color-theme-solarized")
  (require 'solarized-definitions)
  (add-to-list 'load-path "~/.emacs.d/helpa/spacemacs-theme")
  (require 'spacemacs-common)
#+END_SRC

* Functions
** General
#+BEGIN_SRC emacs-lisp
  (defun havner/open-config-org (&optional arg)
    (interactive "P")
    (let ((config "~/.emacs.d/config.org"))
      (if arg
          (find-file-other-window config)
        (find-file config))))
  (global-set-key (kbd "<f12>") 'havner/open-config-org)

  (defun havner/set-ubuntu-font-size (&optional arg)
    (interactive "NFont size: ")
    (let ((font-to-set (concat "Ubuntu Mono-" (number-to-string arg))))
      (set-face-attribute 'default nil :font font-to-set)
      (powerline-reset)))
  (global-set-key (kbd "<M-f12>") 'havner/set-ubuntu-font-size)

  (defun havner/set-font-size (&optional arg)
    (interactive "NFont size: ")
    (set-face-attribute 'default nil :height (* arg 10))
    (powerline-reset))
  (global-set-key (kbd "<C-f12>") 'havner/set-font-size)

  (defun havner/command-line-diff (switch)
    "EDiff two files from command line"
    (let ((file1 (pop command-line-args-left))
          (file2 (pop command-line-args-left)))
      (ediff file1 file2)))
  (add-to-list 'command-switch-alist '("diff" . havner/command-line-diff))

  (defun split-window-prefer-horizonally (window)
    "If there's only one window (excluding any possibly active
           minibuffer), then split the current window horizontally."
    (if (and (one-window-p t)
             (not (active-minibuffer-window)))
        (let ((split-width-threshold 1))
          (split-window-sensibly window))
      (split-window-sensibly window)))

  (defun havner/find-file-as-sudo ()
    (interactive)
    (let ((file-name (buffer-file-name)))
      (when file-name
        (find-alternate-file (concat "/sudo::" file-name)))))

  (let ((langs '("pl_PL" "en_US")))
    (setq havner/lang-ring (make-ring (length langs)))
    (dolist (elem langs) (ring-insert havner/lang-ring elem)))
  (defun havner/cycle-ispell-languages ()
    (interactive)
    (let ((lang (ring-ref havner/lang-ring -1)))
      (ring-insert havner/lang-ring lang)
      (ispell-change-dictionary lang)))

  (defun havner/display-prefix (arg)
    "Display the value of the raw prefix arg."
    (interactive "P")
    (message "%s" arg))

  (defun havner/de-unicode ()
    "Tidy up a buffer by replacing all special Unicode characters
       (smart quotes, etc.) with their more sane cousins"
    (interactive)
    (let ((unicode-map '(("[\u2018\|\u2019\|\u201A\|\uFFFD]" . "'")
                         ("[\u201c\|\u201d\|\u201e]" . "\"")
                         ("\u2013" . "--")
                         ("\u2014" . "---")
                         ("\u2026" . "...")
                         ("\u00A9" . "(c)")
                         ("\u00AE" . "(r)")
                         ("\u2122" . "TM")
                         ("[\u02DC\|\u00A0]" . " "))))
      (save-excursion
        (loop for (key . value) in unicode-map
              do
              (goto-char (point-min))
              (replace-regexp key value)))))

  (defun havner/company-at-point (orig-fun &rest args)
    (if (eq (active-minibuffer-window)
            (selected-window))
        (apply orig-fun args)
      (company-complete)))

  (defun havner/eval-and-replace ()
    "Replace the preceding sexp with its value."
    (interactive)
    (backward-kill-sexp)
    (condition-case nil
        (prin1 (eval (read (current-kill 0)))
               (current-buffer))
      (error (message "Invalid expression")
             (insert (current-kill 0)))))
#+END_SRC

** o/k/1/2/3/0
#+BEGIN_SRC emacs-lisp
  (require 'switch-window)

  ;;;;; extension to switch-window (e.g. kill-window)

  (defun kill-current-buffer ()
    "Kill the current buffer without prompting."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun switch-window-then-kill-buffer ()
      "switch-window--then kill-current-buffer"
    (interactive)
    (switch-window--then
     "Kill buffer in window: "
     #'kill-current-buffer
     #'kill-current-buffer t 1))

  (defun switch-window-then-kill-buffer-and-window ()
      "switch-window--then kill-buffer-and-window"
    (interactive)
    (switch-window--then
     "Kill buffer in window: "
     #'kill-buffer-and-window
     #'kill-buffer-and-window t 1))

  (defun havner/split-window-below-and-switch ()
    "Split the window horizontally, then switch to the new pane."
    (interactive)
    (split-window-below)
    (balance-windows)
    (other-window 1))

  (defun havner/split-window-right-and-switch ()
    "Split the window vertically, then switch to the new pane."
    (interactive)
    (split-window-right)
    (balance-windows)
    (other-window 1))

  ;;;;; OLD

  (defun havner/delete-window-and-balance ()
    "Delete current window and balance"
    (interactive)
    (delete-window)
    (balance-windows))

  (defun havner/kill-buffer-and-window-and-balance ()
    "Kill buffer and window and balance"
    (interactive)
    (kill-buffer-and-window)
    (balance-windows))
#+END_SRC

** Themes
#+BEGIN_SRC emacs-lisp
  (defun havner/disable-themes ()
    (interactive)
    (disable-theme 'solarized)
    (disable-theme 'spacemacs-dark)
    (disable-theme 'spacemacs-light))

  (defun havner/solarized-dark-load ()
    (havner/solarized-settings)
    (setq frame-background-mode 'dark)
    (mapc 'frame-set-background-mode (frame-list))
    (load-theme 'solarized t))
  (defun havner/solarized-light-load ()
    (havner/solarized-settings)
    (setq frame-background-mode 'light)
    (mapc 'frame-set-background-mode (frame-list))
    (load-theme 'solarized t))
  (defun havner/solarized-dark ()
    "Solarized dark"
    (interactive)
    (havner/disable-themes)
    (havner/solarized-dark-load)
    (powerline-reset))
  (defun havner/solarized-light ()
    "Solarized light"
    (interactive)
    (havner/disable-themes)
    (havner/solarized-light-load)
    (powerline-reset))

  (defun havner/spacemacs-dark-load ()
    (havner/spacemacs-settings)
    (load-theme 'spacemacs-dark t))
  (defun havner/spacemacs-light-load ()
    (havner/spacemacs-settings)
    (load-theme 'spacemacs-light t))
  (defun havner/spacemacs-dark ()
    "Spacemacs dark"
    (interactive)
    (havner/disable-themes)
    (havner/spacemacs-dark-load)
    (powerline-reset))
  (defun havner/spacemacs-light ()
    "Spacemacs light"
    (interactive)
    (havner/disable-themes)
    (havner/spacemacs-light-load)
    (powerline-reset))
#+END_SRC

** Mac
#+BEGIN_SRC emacs-lisp
  (defun havner/toggle-frame-fullscreen ()
    "Toggle fullscreen state of selected frame."
    (interactive)
    (let ((fullscreen (frame-parameter nil 'fullscreen)))
      (if (memq fullscreen '(fullscreen fullboth))
          (let ((fullscreen-restore (frame-parameter nil 'fullscreen-restore)))
            (if (memq fullscreen-restore '(maximized fullheight fullwidth))
                (set-frame-parameter nil 'fullscreen fullscreen-restore)
              (set-frame-parameter nil 'fullscreen nil)))
        (set-frame-parameter nil `fullscreen 'fullscreen))))

  ;; Fix the F11 key on emacs-mac-app
  (when window-system 'mac
        (advice-add 'toggle-frame-fullscreen :override #'havner/toggle-frame-fullscreen))
#+END_SRC

* Configuration
** Themes
#+BEGIN_SRC emacs-lisp
  (defun havner/solarized-settings ()
    (setq solarized-termcolors 16))

  (defun havner/spacemacs-settings ()
    (setq spacemacs-theme-comment-bg nil)
    (setq spacemacs-theme-comment-italic t)
    (setq spacemacs-theme-org-height nil))

  (cond (window-system
         (havner/spacemacs-dark-load))
        ((equal (getenv "TERM") "xterm-256color")
         (havner/solarized-dark-load))
        ((equal (getenv "TERM") "xterm-16color")
         (havner/solarized-dark-load)))
#+END_SRC

** Misc options
#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)                ;; Treat 'y' or <CR> as yes, 'n' as no.
  (define-key query-replace-map [return] 'act)
  (define-key query-replace-map [?\C-m] 'act)

  (setq inhibit-startup-screen t)
  (setq scroll-conservatively 101)
  (setq scroll-error-top-bottom t)
  (setq require-final-newline t)
  (setq Man-width 114)
  (setq gc-cons-threshold 20000000)
  (setq calendar-week-start-day 1)
  (setq split-window-preferred-function 'split-window-prefer-horizonally)
  (setq-default truncate-lines t)
  (setq bookmark-default-file "~/.emacs-bookmarks.el")
  (setq recentf-save-file "~/.emacs-recentf.el")

  (when window-system
    (setq confirm-kill-emacs 'y-or-n-p))
  (when (eq window-system 'x)
    (server-start))

  ;; minor modes
  (setq show-paren-delay 0.0)
  (setq display-time-24hr-format t)
  (setq display-time-day-and-date t)
  (setq display-time-default-load-average nil)

  ;; hooks
  (add-hook 'text-mode-hook 'turn-on-auto-fill)
  (add-hook 'after-save-hook 'executable-make-buffer-file-executable-if-script-p)

  (defun havner/delete-trailing-whitespace ()
    (unless (eq mode-name "Diff")
      (delete-trailing-whitespace)))
  (add-hook 'before-save-hook #'havner/delete-trailing-whitespace)
#+END_SRC

** Minor modes
#+BEGIN_SRC emacs-lisp
  ;; GUI
  (menu-bar-mode 0)
  (tool-bar-mode 0)
  (tooltip-mode 0)
  (when window-system
    (scroll-bar-mode 0))

  ;; modeline
  (column-number-mode t)
  (line-number-mode t)
  (size-indication-mode t)
  (display-time-mode t)

  ;; misc / buffer
  (show-paren-mode t)
  (delete-selection-mode t)
  (transient-mark-mode t)
  (global-auto-revert-mode t)
  (recentf-mode t)

  ;; external
  (global-page-break-lines-mode t)
  (global-diff-hl-mode t)
  (beginend-global-mode t)
#+END_SRC

** GUI options
#+BEGIN_SRC emacs-lisp
  (setq use-dialog-box nil)
  (setq default-frame-alist
        '((width . 150)
          (height . 50)
          (top . 100)
          (left . 100)))
  (setq-default cursor-type 'bar)
  (if (eq window-system 'w32)
      (set-face-attribute 'default nil :font "Ubuntu Mono-12"))
#+END_SRC

** Mouse options
#+BEGIN_SRC emacs-lisp
  (setq focus-follows-mouse t)
  (setq mouse-autoselect-window t)
  (setq mouse-yank-at-point t)
  (setq mouse-wheel-scroll-amount '(1 ((shift) . 5) ((control))))
  (cond ((equal (getenv "TERM") "xterm-256color")
         (xterm-mouse-mode t))
        ((equal (getenv "TERM") "xterm-16color")
         (xterm-mouse-mode t))
        ((equal (getenv "TERM") "xterm")
         (xterm-mouse-mode t))
        ((equal (getenv "TERM") "linux")
         (gpm-mouse-mode t)))
#+END_SRC

** GOD mode
#+BEGIN_SRC emacs-lisp
  ;; (god-mode)
  (require 'god-mode)
  (require 'god-mode-isearch)

  (defun god/update-cursor ()
    "Toggle cursor type on god-local-mode"
    (setq cursor-type (if (or god-local-mode)
                          'box
                        'bar)))

  (defun god/toggle-on-overwrite ()
    "Toggle god-mode on overwrite-mode."
    (if (bound-and-true-p overwrite-mode)
        (god-local-mode-pause)
      (god-local-mode-resume)))

  (add-hook 'god-mode-enabled-hook #'god/update-cursor)
  (add-hook 'god-mode-disabled-hook #'god/update-cursor)
  (add-to-list 'god-exempt-major-modes 'term-mode)
  (add-to-list 'god-exempt-major-modes 'bs-mode)

  (add-hook 'overwrite-mode-hook #'god/toggle-on-overwrite)
  (add-hook 'god-mode-enabled-hook (lambda nil
                                     (overwrite-mode 0)))
#+END_SRC

** Backups
#+BEGIN_SRC emacs-lisp
  (setq temporary-file-directory "~/tmp")
  (unless (file-directory-p temporary-file-directory)
      (mkdir temporary-file-directory))

  (setq backup-directory-alist
        `((".*" . ,temporary-file-directory)))
  (setq auto-save-list-file-prefix
        (concat temporary-file-directory "/auto-save-list/.saves-"))
  ;; (setq auto-save-file-name-transforms
  ;;       `((".*" ,temporary-file-directory t)))
#+END_SRC

** Tab related
#+BEGIN_SRC emacs-lisp
  (setq tab-always-indent 'complete)
  (setq backward-delete-char-untabify-method nil)
  (setq-default indent-tabs-mode t)
  (setq-default tab-width 8)

  (advice-add 'completion-at-point :around #'havner/company-at-point)
#+END_SRC

** Undo/Redo
#+BEGIN_SRC emacs-lisp
  (require 'point-undo)             ;; autoloads empty, load manually
  (require 'redo+)                  ;; autoloads empty, load manually
  (setq undo-no-redo t)

  (global-undo-tree-mode t)
#+END_SRC

** AVY
#+BEGIN_SRC emacs-lisp
  (setq avy-keys (append (number-sequence ?a ?z) (number-sequence ?A ?Z)))
  (setq avy-background t)
#+END_SRC

** Switch window
#+BEGIN_SRC emacs-lisp
  (setq switch-window-increase 6)
  (setq switch-window-minibuffer-shortcut ?x)

  ;; switch-window autoresize (ala zoom/golden-ration)
  ;; (setq switch-window-auto-resize-window t)
  ;; (setq switch-window-default-window-size '(0.618 . 0.618))
  ;; (switch-window-mouse-mode t)
#+END_SRC

** Buffer Show
#+BEGIN_SRC emacs-lisp
  (setq bs-configurations
        '(("all" nil nil nil nil nil)
          ("files" nil nil nil bs-visits-non-file bs-sort-buffer-interns-are-last)
          ("files-and-scratch" "^\\*scratch\\*$" nil nil bs-visits-non-file bs-sort-buffer-interns-are-last)
          ("all-intern-last" nil nil nil nil bs-sort-buffer-interns-are-last)
          ("havner" "^\\*ansi-term\\*" nil nil bs-visits-non-file bs--sort-by-name)))
  (setq bs-default-configuration "havner")
#+END_SRC

** BM
#+BEGIN_SRC emacs-lisp
  (setq bm-repository-file "~/.emacs-bm.el")
  (setq bm-restore-repository-on-load t)
  (setq bm-annotate-on-create nil)
  (setq-default bm-buffer-persistence t)
  (if window-system
      (setq-default bm-highlight-style 'bm-highlight-only-fringe)
    (setq-default bm-highlight-style 'bm-highlight-only-line))
  (require 'bm)
  (add-hook 'find-file-hooks 'bm-buffer-restore)
  (add-hook 'kill-buffer-hook 'bm-buffer-save)
  (add-hook 'kill-emacs-hook (lambda nil
                               (bm-buffer-save-all)
                               (bm-repository-save)))
  (add-hook 'after-save-hook 'bm-buffer-save)
  (add-hook 'after-revert-hook 'bm-buffer-restore)
#+END_SRC

** Nlinum
#+BEGIN_SRC emacs-lisp
  (require 'nlinum-hl)

  (if window-system
      (setq nlinum-format " %d")
    (setq nlinum-format " %d "))
#+END_SRC

** Whitespace
#+BEGIN_SRC emacs-lisp
  (setq whitespace-line-column 80)
  (cond (window-system
         (setq whitespace-style '(face tabs spaces trailing lines-tail space-mark tab-mark)))
        ((equal (getenv "TERM") "xterm-256color")
         (setq whitespace-style '(face tabs spaces trailing lines-tail space-mark tab-mark)))
        ((equal (getenv "TERM") "xterm-16color")
         (setq whitespace-style '(face tabs spaces trailing lines-tail space-mark tab-mark)))
        ((equal (getenv "TERM") "xterm")
         (setq whitespace-style '(face trailing lines-tail tab-mark)))
        ((equal (getenv "TERM") "linux")
         (setq whitespace-style '(face trailing lines-tail tab-mark))))
#+END_SRC

** Desktop save
#+BEGIN_SRC emacs-lisp
  (when (eq window-system 'x)
    (setq desktop-base-file-name "desktop")
    (setq desktop-save 'ask-if-exists)
    (desktop-save-mode t))
#+END_SRC

** Helm
#+BEGIN_SRC emacs-lisp
  (helm-mode t)

  (when helm-mode
    (setq helm-always-two-windows t)
    (setq helm-split-window-default-side 'right)
    (setq helm-candidate-number-limit 1000)
    (setq helm-findutils-search-full-path t)
    (setq helm-bookmark-show-location t)

    (if (eq system-type 'darwin)
        (setq helm-locate-command "/opt/local/bin/glocate %s -e -A -i --regex %s")))
#+END_SRC

** Projectile
#+BEGIN_SRC emacs-lisp
  (projectile-mode t)

  (setq projectile-known-projects-file "~/.emacs-projectile.el")
  (setq projectile-mode-line '(:eval (format " P[%s]" (projectile-project-name))))
  (setq frame-title-format '((:eval (projectile-project-name))))

  (when helm-mode
    (setq projectile-completion-system 'helm)
    (helm-projectile-on))
#+END_SRC

** Company
#+BEGIN_SRC emacs-lisp
  (global-company-mode t)

  (setq company-backends
        '(company-elisp
          company-files
          company-ispell))

  (setq company-idle-delay 0.5)
  (setq company-minimum-prefix-length 3)
#+END_SRC

** Flycheck
#+BEGIN_SRC emacs-lisp
  (setq-default flycheck-disabled-checkers '(c/c++-gcc c/c++-clang python-flake8 python-pylint))
#+END_SRC

** TODO Flycheck-python
#+BEGIN_SRC emacs-lisp
  (setq flycheck-python-flake8-executable "flake8-3")
  (setq flycheck-python-pylint-executable "python3-pylint")

  (require 'flycheck-pycheckers)
  (setq flycheck-pycheckers-checkers '(pylint pep8 flake8))
  (setq flycheck-pycheckers-max-line-length 80)
  (eval-after-load 'flycheck
    '(add-hook 'flycheck-mode-hook 'flycheck-pycheckers-setup))
#+END_SRC

** Eyebrowse
#+BEGIN_SRC emacs-lisp
  (setq eyebrowse-keymap-prefix (kbd "C-c w"))
  (setq eyebrowse-wrap-around t)
  (setq eyebrowse-new-workspace t)
  (eyebrowse-mode t)
#+END_SRC

** Powerline / Spaceline
#+BEGIN_SRC emacs-lisp
  (when window-system
    (require 'spaceline-config)
    (spaceline-spacemacs-theme)
    (when helm-mode
      (spaceline-helm-mode)))
#+END_SRC

** Dired
#+BEGIN_SRC emacs-lisp
  (setq dired-dwim-target t)
  (setq dired-listing-switches "-alhB --group-directories-first")
  (if (eq system-type 'darwin)
      (setq insert-directory-program "gls"))
#+END_SRC

** EDiff
#+BEGIN_SRC emacs-lisp
  (setq ediff-split-window-function 'split-window-horizontally)
  (setq ediff-window-setup-function 'ediff-setup-windows-plain)

  (defvar havner/ediff-last-windows nil)
  (defun havner/store-pre-ediff-winconfig ()
    (setq havner/ediff-last-windows (current-window-configuration)))
  (defun havner/restore-pre-ediff-winconfig ()
    (set-window-configuration havner/ediff-last-windows))

  (add-hook 'ediff-before-setup-hook #'havner/store-pre-ediff-winconfig)
  (add-hook 'ediff-quit-hook #'havner/restore-pre-ediff-winconfig)
#+END_SRC

** Magit
#+BEGIN_SRC emacs-lisp
  (setq magit-repository-directories '(("~/devel/" . 2) ("~/.emacs.d/" . 1) ("~/Documents/" . 1)))

  (eval-after-load 'magit-popup
    '(magit-define-popup-switch
      'magit-rebase-popup
      ?f "Find a better common ancestor" "--fork-point"))
#+END_SRC

** Compile
#+BEGIN_SRC emacs-lisp
  (setq compilation-read-command nil)
  (setq compilation-scroll-output t)
#+END_SRC

** GDB
#+BEGIN_SRC emacs-lisp
  (setq gdb-many-windows t)
  (setq gdb-show-main t)
#+END_SRC

** ORG
#+BEGIN_SRC emacs-lisp
  (setq process-connection-type nil)  ;; makes it possible to use xdg-open

  (setq org-directory "~/Dropbox/emacs/org")
  (defun org-file-path (filename)
    "Return the absolute address of an org file, given its relative name."
    (concat (file-name-as-directory org-directory) filename))
  (setq org-index-file (org-file-path "index.org"))

  (setq org-default-notes-file org-index-file)
  (setq org-agenda-files (list org-index-file))
  (setq org-archive-location (concat (org-file-path "archive.org") "::* From %s"))
  ;; (setq org-mobile-inbox-for-pull (org-file-path "mobile.org"))
  ;; (setq org-mobile-directory "~/Dropbox/Apps/MobileOrg")

  (setq org-log-done 'time)
  (setq org-src-fontify-natively t)
  (setq org-src-tab-acts-natively t)
  (setq org-src-window-setup 'current-window)
  (setq org-startup-indented t)
  (setq org-support-shift-select t)
  (setq org-babel-python-command "python3")
  (setq org-confirm-babel-evaluate nil)
  (setq org-beamer-theme "Warsaw")
  (setq org-highlight-latex-and-related '(latex))

  (org-babel-do-load-languages 'org-babel-load-languages '((emacs-lisp . t) (python . t) (C . t)))

  (add-hook 'org-mode-hook 'turn-on-auto-fill)
  (unless (eq window-system 'w32)
    ;; (setq org-ellipsis "â¤µ")
    (add-hook 'org-mode-hook 'org-bullets-mode))

  (require 'ox-twbs)
  (require 'ox-beamer)

  (setq org-latex-listings 'minted
        org-latex-packages-alist '(("" "minted"))
        org-latex-pdf-process
        '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))

  (add-to-list 'org-structure-template-alist
               '("el" "#+BEGIN_SRC emacs-lisp\n?\n#+END_SRC"))
  (add-to-list 'org-structure-template-alist
               '("tt" "#+TITLE: ?"))
  (add-to-list 'org-structure-template-alist
               '("at" "#+AUTHOR: ?"))

  ;; (define-key org-mode-map [(control ?,)] nil)
  (define-key org-mode-map [(control ?\')] nil)
#+END_SRC

** Delight (free your modeline)
#+BEGIN_SRC emacs-lisp
  (delight '(
             (beginend-global-mode nil "beginend")
             (beginend-bs-mode nil "beginend")
             (beginend-prog-mode nil "beginend")
             (beginend-dired-mode nil "beginend")
             (beginend-org-agenda-mode nil "beginend")
             (beginend-compilation-mode nil "beginend")
             (beginend-magit-status-mode nil "beginend")
             (beginend-prodigy-mode nil "beginend")
             (beginend-vc-dir-mode nil "beginend")
             (beginend-ibuffer-mode nil "beginend")
             (org-indent-mode nil "org-indent")
             (company-mode nil "company")
             (helm-mode nil "helm-mode")
             (page-break-lines-mode nil "page-break-lines")
             (subword-mode nil "subword")
             (auto-revert-mode nil "autorevert")
             (auto-fill-function nil "simple")
             (abbrev-mode nil "abbrev")
             (paredit-mode nil "paredit")
             (undo-tree-mode nil "undo-tree")
             ))
#+END_SRC

** Engine mode
#+BEGIN_SRC emacs-lisp
  (require 'engine-mode)

  (defengine duckduckgo
    "https://duckduckgo.com/?q=%s"
    :keybinding "d")
  (defengine google
    "http://www.google.com/search?ie=utf-8&oe=utf-8&q=%s"
    :keybinding "g")
  (defengine stack-overflow
    "https://stackoverflow.com/search?q=%s"
    :keybinding "s")
  (defengine wikipedia
    "http://www.wikipedia.org/search-redirect.php?language=en&go=Go&search=%s"
    :keybinding "w")
  (defengine youtube
    "https://www.youtube.com/results?search_query=%s"
      :keybinding "y")
  (defengine github
    "https://github.com/search?ref=simplesearch&q=%s")
  (defengine rfcs
    "http://pretty-rfc.herokuapp.com/search?q=%s")
  (defengine wiktionary
    "https://www.wikipedia.org/search-redirect.php?family=wiktionary&language=en&go=Go&search=%s")

  (engine/set-keymap-prefix (kbd "C-c s"))
  ;; (setq engine/browser-function 'eww-browse-url)

  (engine-mode t)
#+END_SRC

** Elfeed
#+BEGIN_SRC emacs-lisp
  (setq elfeed-search-filter "@12-months-ago +unread")
  (setq elfeed-db-directory "~/Dropbox/emacs/elfeed")
  (elfeed-org)
#+END_SRC

** Zone
#+BEGIN_SRC emacs-lisp
  (require 'zone)
  (zone-when-idle 300)
#+END_SRC

* Configuration + ext tools
#+BEGIN_SRC emacs-lisp
  (setq system-config-directory (concat "~/.emacs.d/bin-" system-configuration))
  (setq system-config-directory-bin (concat system-config-directory "/bin"))
  (unless (file-directory-p system-config-directory-bin)
    (mkdir system-config-directory-bin t))
#+END_SRC

** PDF
#+BEGIN_SRC emacs-lisp
  (setq pdf-info-epdfinfo-program
        (concat system-config-directory-bin "/epdfinfo"))

  (when window-system
    (pdf-tools-install))
#+END_SRC

** RTags
#+BEGIN_SRC emacs-lisp
  (setq rtags-path system-config-directory)

  (when helm-mode
    (setq rtags-display-result-backend 'helm))

  ;;; company-rtags
  ;; (require 'company-rtags)
  ;; (setq rtags-autostart-diagnostics t)
  ;; (setq rtags-completions-enabled t)

  (add-hook 'c-mode-common-hook 'rtags-start-process-unless-running)
#+END_SRC

** Irony
#+BEGIN_SRC emacs-lisp
  (setq irony-server-install-prefix system-config-directory)

  (setq company-dabbrev-code-ignore-case 'smart)

  (add-hook 'irony-mode-hook 'irony-cdb-autosetup-compile-options)
  (add-hook 'flycheck-mode-hook 'flycheck-irony-setup)
#+END_SRC

* Programming modes
#+BEGIN_SRC emacs-lisp
  (defun prog-devel-hook-f ()
    (nlinum-mode t)
    (hl-line-mode t)
    (subword-mode t)
    (prettify-symbols-mode t)
    (setq show-trailing-whitespace t))
  (add-hook 'prog-mode-hook #'prog-devel-hook-f)
#+END_SRC

** C
#+BEGIN_SRC emacs-lisp
  (defvaralias 'c-basic-offset 'tab-width)
  (smart-tabs-insinuate 'c 'c++)
  (setq c-tab-always-indent nil)
  (setq c-insert-tab-function 'company-complete)

  (add-to-list 'auto-mode-alist '("\\.h\\'" . c++-mode))      ; *.h in c++-mode

  (setq c-default-style
        '((c-mode . "linux")
          (c++-mode . "stroustrup")
          (java-mode . "java")
          (awk-mode . "awk")
          (other . "gnu")))

  (defun c-devel-hook-f()
    (c-set-offset 'innamespace 0)
    (c-set-offset 'inextern-lang 0)
    (c-set-offset 'inline-open 0)
    (irony-mode t)
    (flycheck-mode t)
    (setq-local company-backends
                '((company-irony-c-headers company-irony)
                  ;; company-rtags
                  company-keywords
                  company-files
                  company-ispell)))
  (add-hook 'c-mode-common-hook #'c-devel-hook-f)
#+END_SRC

** Python
#+BEGIN_SRC emacs-lisp
  (defvaralias 'python-indent-offset 'tab-width)
  ;; (smart-tabs-insinuate 'python)

  (defun python-devel-hook-f ()
    (flycheck-mode t)
    (setq tab-width 4)
    (setq indent-tabs-mode nil)
    (setq-local company-backends
                '(company-jedi
                  company-keywords
                  company-files
                  company-ispell)))
  (add-hook 'python-mode-hook #'python-devel-hook-f)
#+END_SRC

** LUA
#+BEGIN_SRC emacs-lisp
  (defvaralias 'lua-indent-level 'tab-width)

  (defun lua-devel-hook-f ()
    (setq tab-width 4))
  (add-hook 'lua-mode-hook #'lua-devel-hook-f)
#+END_SRC

** Lisps
#+BEGIN_SRC emacs-lisp
  (require 'paredit-menu)

  (defun lisps-devel-hook-f ()
    (setq indent-tabs-mode nil)
    (paredit-mode t)
    (rainbow-delimiters-mode t))
  (setq lisps-mode-hooks
        '(emacs-lisp-mode-hook
          lisp-mode-hook
          scheme-mode-hook))
  (dolist (hook lisps-mode-hooks)
    (add-hook hook #'lisps-devel-hook-f))
#+END_SRC

** shell
#+BEGIN_SRC emacs-lisp
  (defvaralias 'sh-indentation 'tab-width)
  (defvaralias 'sh-basic-offset 'tab-width)

  (defun sh-devel-hook-f ()
    (setq tab-width 4))
  (add-hook 'sh-mode-hook #'sh-devel-hook-f)
#+END_SRC

** NXML
#+BEGIN_SRC emacs-lisp
  (defvaralias 'nxml-child-indent 'tab-width)
  (smart-tabs-insinuate 'nxml)

  (defun nxml-devel-hook-f ()
    (setq tab-width 2))
  (add-hook 'nxml-mode-hook #'nxml-devel-hook-f)
#+END_SRC

* Shortcuts
** Navigation
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "M-n") 'forward-paragraph)
  (global-set-key (kbd "M-p") 'backward-paragraph)
#+END_SRC

*** Description

left/right:
  - char
  - word
next/previous:
  - line
forward/backward:
  - char
  - word
  - line
  - sentence
  - paragraph

|-------+------------+-----------------|
|       | Ctrl       | Meta            |
|-------+------------+-----------------|
| f     | forw char  | forw word       |
| b     | back char  | back word       |
| n     | next line  | forw paragraph* |
| p     | prev line  | back paragraph* |
| e     | line end   | forw sentence   |
| a     | line begin | back sentence   |
|-------+------------+-----------------|
|       | (none)     | Ctrl            |
|-------+------------+-----------------|
| right | right char | right word      |
| left  | left char  | left word       |
| down  | next line  | forw paragraph  |
| up    | prev line  | back paragraph  |
|-------+------------+-----------------|

** No CUA-mode
#+BEGIN_SRC emacs-lisp
  ;; (global-set-key (kbd "C-c c") 'kill-ring-save)
  ;; (global-set-key (kbd "C-c x") 'kill-region)
  ;; (global-set-key (kbd "C-c v") 'yank)
  ;; (global-set-key (kbd "C-c C-v") 'yank-pop)
  (global-set-key (kbd "C-z") 'undo)
#+END_SRC

** Undo/Redo
#+BEGIN_SRC emacs-lisp
  ;; (global-set-key (kbd "C-_") 'undo)
  (global-set-key (kbd "M-_") 'redo)
  ;; (global-set-key (kbd "C-/") 'undo)
  (global-set-key (kbd "C-?") 'redo)
  ;; (global-set-key (kbd "C-z") 'undo)
  (global-set-key (kbd "M-z") 'redo)
  #+END_SRC

** Windows/buffers
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "<f6>") 'point-undo)              ;; do I need this? learn mark
  (global-set-key (kbd "<f7>") 'point-redo)

  (global-set-key (kbd "C-x <left>") 'windmove-left)
  (global-set-key (kbd "C-x <right>") 'windmove-right)
  (global-set-key (kbd "C-x <up>") 'windmove-up)
  (global-set-key (kbd "C-x <down>") 'windmove-down)

  (global-set-key (kbd "C-c <up>") 'buf-move-up)
  (global-set-key (kbd "C-c <down>") 'buf-move-down)
  (global-set-key (kbd "C-c <left>") 'buf-move-left)
  (global-set-key (kbd "C-c <right>") 'buf-move-right)
#+END_SRC

** Builtin modules
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-x d") 'list-directory)
  (global-set-key (kbd "C-x C-d") 'dired)
  (global-set-key (kbd "C-s") 'isearch-forward-regexp)
  (global-set-key (kbd "C-r") 'isearch-backward-regexp)

  (global-set-key (kbd "C-x C-j") 'dired-jump)
  (global-set-key (kbd "C-x p") 'other-frame)
  (global-set-key (kbd "C-x C-p") 'make-frame)
  (global-set-key (kbd "C-x w") 'whitespace-mode)
  (global-set-key (kbd "C-x t") 'toggle-truncate-lines)
  (global-set-key (kbd "C-x b") 'ibuffer)
  (global-set-key (kbd "C-x C-b") 'bookmark-bmenu-list)

  (global-set-key (kbd "C-c i") 'ispell-word)
  (global-set-key (kbd "C-.") 'imenu)
  (global-set-key (kbd "<f5>") 'compile)
  (global-set-key (kbd "<C-f9>") 'locate)
  (global-set-key (kbd "<C-f10>") 'recentf-open-files)
  (define-key isearch-mode-map (kbd "C-l") 'recenter-top-bottom)

  (global-set-key (kbd "C-c l") 'org-store-link)
  (global-set-key (kbd "C-c c") 'org-capture)
  (global-set-key (kbd "C-c a") 'org-agenda)

  (define-key dired-mode-map (kbd "<tab>") 'other-window)
#+END_SRC

** External modules
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-x o") 'switch-window)                                ;; thr 2+
  (global-set-key (kbd "C-x C-o") 'switch-window-then-swap-buffer)             ;; thr 2+
  (global-set-key (kbd "C-x k") 'switch-window-then-kill-buffer)               ;; thr 1+
  (global-set-key (kbd "C-x C-k") 'switch-window-then-kill-buffer-and-window)  ;; thr 1+
  (global-set-key (kbd "C-x 0") 'switch-window-then-delete)                    ;; thr 2+
  (global-set-key (kbd "C-x 1") 'switch-window-then-maximize)                  ;; thr 2+
  ;; (global-set-key (kbd "C-x 2") 'switch-window-then-split-below)               ;; thr 1+
  ;; (global-set-key (kbd "C-x 3") 'switch-window-then-split-right)               ;; thr 1+
  (global-set-key (kbd "C-x 2") 'havner/split-window-below-and-switch)
  (global-set-key (kbd "C-x 3") 'havner/split-window-right-and-switch)

  (global-set-key (kbd "C-`") 'sane-term)
  (global-set-key (kbd "C-x y") 'sane-term-create)
  (global-set-key (kbd "C-x C-S-f") 'havner/find-file-as-sudo)

  (define-key eyebrowse-mode-map (kbd "C-c w p") 'eyebrowse-prev-window-config)
  (define-key eyebrowse-mode-map (kbd "C-c w n") 'eyebrowse-next-window-config)
  (define-key eyebrowse-mode-map (kbd "C-c w k") 'eyebrowse-close-window-config)
  (define-key eyebrowse-mode-map (kbd "C-c w m") 'eyebrowse-rename-window-config)

  (global-set-key (kbd "C-c o") 'windresize)
  (global-set-key (kbd "C-c b") 'bm-show-all)
  (global-set-key (kbd "C-c h") 'highlight-thing-mode)
  (global-set-key (kbd "C-c v") 'volume)
  (global-set-key (kbd "<C-f5>") 'projectile-compile-project)

  (global-set-key (kbd "C-c m") 'magit-status)
  (global-set-key (kbd "C-c C-m") 'magit-log-head)
  (global-set-key (kbd "C-c g") 'magit-file-popup)
  (global-set-key (kbd "C-c C-g") 'magit-dispatch-popup)

  (global-set-key (kbd "C-'") 'avy-goto-word-1)
  (global-set-key (kbd "C-;") 'avy-pop-mark)
  (define-key isearch-mode-map (kbd "C-'") 'avy-isearch)

  (global-set-key (kbd "<C-f2>") 'bm-toggle)
  (global-set-key (kbd "<f2>")   'bm-next)
  (global-set-key (kbd "<S-f2>") 'bm-previous)
  (global-set-key (kbd "<left-fringe> <mouse-5>") 'bm-next-mouse)
  (global-set-key (kbd "<left-fringe> <mouse-4>") 'bm-previous-mouse)
  (global-set-key (kbd "<left-fringe> <mouse-1>") 'bm-toggle-mouse)

  (eval-after-load 'cc-mode
    '(progn
       (rtags-enable-standard-keybindings c-mode-base-map)
       (define-key c-mode-base-map (kbd "C-x j") 'rtags-find-symbol-at-point)
       (define-key c-mode-base-map (kbd "M-.") 'rtags-find-references-at-point)
       (define-key c-mode-base-map (kbd "M-,") 'rtags-location-stack-back)
       (define-key c-mode-base-map (kbd "C-.") 'rtags-imenu)))

  (eval-after-load 'company
    '(progn
       (define-key company-template-field-map (kbd "<tab>") nil)
       (define-key company-template-field-map '[?\t] nil)
       (define-key company-template-field-map (kbd "M-f") 'company-template-forward-field)
       (define-key company-template-nav-map (kbd "<tab>") nil)
       (define-key company-template-nav-map '[?\t] nil)
       (define-key company-template-nav-map (kbd "M-f") 'company-template-forward-field)))

  (eval-after-load 'flycheck
    '(define-key flycheck-mode-map (kbd "<f4>") 'flycheck-list-errors))

  (eval-after-load 'projectile
    '(define-key projectile-mode-map (kbd "<f10>") 'projectile-commander))
#+END_SRC

** Helm
#+BEGIN_SRC emacs-lisp
  (when helm-mode
    (global-set-key (kbd "M-x") 'helm-M-x)
    (global-set-key (kbd "C-h a") 'helm-apropos)
    (global-set-key (kbd "C-h m") 'helm-describe-modes)
    (global-set-key (kbd "C-h b") 'helm-descbinds)
    (global-set-key (kbd "M-y") 'helm-show-kill-ring)
    (global-set-key (kbd "C-x C-f") 'helm-find-files)
    (global-set-key (kbd "C-x b") 'helm-buffers-list)
    (global-set-key (kbd "C-x C-b") 'helm-bookmarks)
    (global-set-key (kbd "<f1>") 'helm-resume)
    (global-set-key (kbd "<f8>") 'helm-occur)
    (global-set-key (kbd "<f9>") 'helm-find)
    (global-set-key (kbd "<C-f9>") 'helm-locate)
    (global-set-key (kbd "<C-f10>") 'helm-recentf)
    (global-set-key (kbd "C-c i") 'helm-flyspell-correct)
    (global-set-key (kbd "C-c b") 'helm-bm)
    (global-set-key (kbd "C-.") 'helm-imenu)
    (global-set-key (kbd "C-,") 'helm-imenu-in-all-buffers))

  (eval-after-load 'helm
    '(progn
       (define-key helm-map (kbd "<tab>") 'helm-execute-persistent-action)
       (define-key helm-map (kbd "C-i") 'helm-execute-persistent-action)
       (define-key helm-map (kbd "<backtab>") 'helm-find-files-up-one-level)
       (define-key helm-map (kbd "C-z") 'helm-select-action)
       (define-key helm-map (kbd "<C-tab>") 'helm-next-source)))

  (eval-after-load 'company
    '(when helm-mode
       (define-key company-mode-map (kbd "<f3>") 'helm-company)
       (define-key company-active-map (kbd "<f3>") 'helm-company)))

  (eval-after-load 'flycheck
    '(when helm-mode
       (define-key flycheck-mode-map (kbd "<f4>") 'helm-flycheck)))

  (eval-after-load 'projectile
    '(when helm-mode
       (define-key projectile-mode-map (kbd "<f10>") 'helm-projectile)))
#+END_SRC

** GOD mode
#+BEGIN_SRC emacs-lisp
  ;; (global-set-key (kbd "<escape>") 'god-local-mode)
  (define-key god-local-mode-map (kbd "i") 'god-local-mode)
  (define-key god-local-mode-map (kbd "<escape> <escape> <escape>") 'keyboard-escape-quit)
  (define-key god-local-mode-map (kbd "<escape>") 'keyboard-escape-quit)

  (define-key isearch-mode-map (kbd "<escape>") 'god-mode-isearch-activate)
  (define-key god-mode-isearch-map (kbd "<escape>") 'god-mode-isearch-disable)
  (define-key god-mode-isearch-map (kbd "'") 'avy-isearch)
  (define-key god-mode-isearch-map (kbd "l") 'recenter-top-bottom)

  (define-key org-mode-map (kbd "C-c C-'") 'org-edit-special)
  (define-key org-src-mode-map (kbd "C-c C-'") 'org-edit-src-exit)

  (global-set-key (kbd "C-x C-0") 'switch-window-then-delete)                ;; thr 2+
  (global-set-key (kbd "C-x C-1") 'switch-window-then-maximize)              ;; thr 2+
  ;; (global-set-key (kbd "C-x C-2") 'switch-window-then-split-below)           ;; thr 1+
  ;; (global-set-key (kbd "C-x C-3") 'switch-window-then-split-right)           ;; thr 1+
  (global-set-key (kbd "C-x C-2") 'havner/split-window-below-and-switch)
  (global-set-key (kbd "C-x C-3") 'havner/split-window-right-and-switch)

  (when (bound-and-true-p god-global-mode)
    (global-set-key (kbd "C-x C-o") 'switch-window)                            ;; thr 2+
    (global-set-key (kbd "C-x o") 'switch-window-then-swap-buffer)             ;; thr 2+
    (global-set-key (kbd "C-x C-k") 'switch-window-then-kill-buffer)           ;; thr 1+
    (global-set-key (kbd "C-x k") 'switch-window-then-kill-buffer-and-window)  ;; thr 1+

    (global-set-key (kbd "C-x b") 'helm-bookmarks)
    (global-set-key (kbd "C-x C-b") 'helm-buffers-list)
    (global-set-key (kbd "C-x p") 'make-frame)
    (global-set-key (kbd "C-x C-p") 'other-frame))
#+END_SRC

* Autostart
#+BEGIN_SRC emacs-lisp
  (org-agenda nil "n")
  (delete-other-windows)
#+END_SRC

* Unused
** Evil
#+BEGIN_SRC emacs-lisp
  ;; (evil-mode t)

  ;; (evil-set-initial-state 'term-mode 'emacs)
  ;; (evil-set-initial-state 'gomoku-mode 'emacs)

  ;; (setq evil-want-C-i-jump nil)
#+END_SRC

** Dashboard
#+BEGIN_SRC emacs-lisp
  ;; (setq dashboard-banner-logo-title "Abandon hope all ye who enter here")
  ;; ;; (setq dashboard-startup-banner "~/path/to/image.png")
  ;; (setq dashboard-items '(
  ;;                         (agenda . 5)
  ;;                         (bookmarks . 5)
  ;;                         (recents  . 5)
  ;;                         (projects . 5)
  ;;                         (registers . 5)
  ;;                         ))
  ;; (dashboard-setup-startup-hook)
#+END_SRC

** EDE/Semantic
#+BEGIN_SRC emacs-lisp
  ;; (setq ede-project-placeholder-cache-file nil)
  ;; (setq project-linux-compile-project-command "gmake -j4 -C %s") ; EDE compilation command for kernel

  ;; (setq semantic-c-dependency-system-include-path '("/usr/include" "/usr/local/include" "/usr/include/python3.5m"))
  ;; (setq semantic-default-submodes '(
  ;;                                   global-semantic-idle-scheduler-mode
  ;;                                   global-semanticdb-minor-mode
  ;;                                   global-semantic-idle-summary-mode
  ;;                                   ;; global-semantic-idle-completions-mode
  ;;                                   ))
  ;; (setq semanticdb-default-save-directory "~/.semanticdb")

  ;; (global-ede-mode t)
  ;; (semantic-mode t)

  ;; (setq ede-projects-list-file "~/.emacs-ede.el")
  ;; (if (file-exists-p ede-projects-list-file)
  ;;     (load-file ede-projects-list-file))
#+END_SRC

** Games
#+BEGIN_SRC emacs-lisp
  ;; (setq dun-log-file "~/Dropbox/emacs/dunnet.score")
#+END_SRC

* Notes
** C-x available keys:
- c
- g
- j (semantic/ff-other-file)
- p (frame)
- t (truncate)
- w (whitespace) (TODO: hi lock mode)
- x
- y (sane-term)

** C-x C- available keys:
- a
- g
- h
- j (dired-jump)
- y
